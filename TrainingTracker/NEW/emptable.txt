CREATE TABLE  "TT_EMPLOYEE" 
   (	"EMP_ID" VARCHAR2(50), 
	"DESIGNATION" VARCHAR2(15), 
	"MANAGER_ID" VARCHAR2(50), 
	 CONSTRAINT "EMP_PK" PRIMARY KEY ("EMP_ID")
  USING INDEX  ENABLE
   )
/
ALTER TABLE  "TT_EMPLOYEE" ADD CONSTRAINT "MGR_FK" FOREIGN KEY ("MANAGER_ID")
	  REFERENCES  "TT_EMPLOYEE" ("EMP_ID") ON DELETE CASCADE ENABLE
/

CREATE OR REPLACE EDITIONABLE TRIGGER  "TT_EMPLOYEE_MANAGER" 
  before insert or update on TT_EMPLOYEE
  for each row
begin
    if inserting then
        :new.MANAGER_ID := v('P12_MANAGER_ID');
        :new.EMP_ID  := UPPER(:new.EMP_ID);
    end if;
end;

/
ALTER TRIGGER  "TT_EMPLOYEE_MANAGER" ENABLE
/

CREATE OR REPLACE EDITIONABLE TRIGGER  "TT_MGR_ACL_INSERT" 
AFTER INSERT ON  TT_EMPLOYEE
FOR EACH ROW

BEGIN 

   IF ( INSTR(:new.DESIGNATION,'M' ) > 0  ) 
   THEN

     INSERT INTO TTE_MANAGER_PROFILE  ( MANAGER_ID,PLA_LINE, PLA_FAMILY,PLA_AREA )  ;  
	 SELECT :new.emp_id, PLA_LINE, PLA_FAMILY,PLA_AREA
     FROM TTE_MANAGER_PROFILE
     WHERE MANAGER_ID = v('P12_MANAGER_ID');

     INSERT INTO APEX_ACCESS_CONTROL (ADMIN_USERNAME, ADMIN_PRIVILEGES, SETUP_ID)  VALUES (:new.emp_id, 'EDIT',1);

   ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0 AND NOT (INSTR(:new.DESIGNATION,'View') > 0)) 
   THEN
   
     INSERT INTO TT_EMPLOYEE_PLA_ACCESS  ( EMP_ID, PLA_LINE, PLA_FAMILY,PLA_AREA )  ;  
	 SELECT :new.emp_id, PLA_LINE, PLA_FAMILY,PLA_AREA
     FROM TTE_MANAGER_PROFILE
	 
     WHERE MANAGER_ID = v('P12_MANAGER_ID');
	
   ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0 AND (INSTR(:new.DESIGNATION,'View') > 0)) 
   THEN 
   
     INSERT INTO TT_EMPLOYEE_PLA_ACCESS  ( EMP_ID, PLA_LINE, PLA_FAMILY,PLA_AREA )  ;  
	 SELECT :new.emp_id, PLA_LINE, PLA_FAMILY,PLA_AREA
     FROM TTE_MANAGER_PROFILE
     WHERE MANAGER_ID = v('P12_MANAGER_ID');
	 
     INSERT INTO APEX_ACCESS_CONTROL (ADMIN_USERNAME, ADMIN_PRIVILEGES, SETUP_ID)  VALUES (:new.emp_id, 'EDIT',1);	 
	
END;

/
ALTER TRIGGER  "TT_MGR_ACL_INSERT" ENABLE
/

CREATE OR REPLACE EDITIONABLE TRIGGER  "TT_MGR_ACL_UPDATE" 
AFTER UPDATE ON  TT_EMPLOYEE
FOR EACH ROW
BEGIN

  IF (INSTR(:new.DESIGNATION,'M' ) > 0 AND INSTR(:old.DESIGNATION ,'IC') > 0  AND NOT (INSTR(:old.DESIGNATION,'View') > 0)) THEN 
     INSERT INTO TTE_MANAGER_PROFILE  ( MANAGER_ID)  VALUES       ( :new.emp_id);  
     INSERT INTO APEX_ACCESS_CONTROL (ADMIN_USERNAME, ADMIN_PRIVILEGES, SETUP_ID)  VALUES (:new.emp_id, 'EDIT',1);
  ELSIF (INSTR(:new.DESIGNATION,'M' ) > 0 AND INSTR(:old.DESIGNATION ,'IC') > 0  AND (INSTR(:old.DESIGNATION,'View') > 0)) THEN
     INSERT INTO TTE_MANAGER_PROFILE  ( MANAGER_ID)  VALUES       ( :new.emp_id);  
     UPDATE APEX_ACCESS_CONTROL SET ADMIN_PRIVILEGES = 'EDIT' WHERE ADMIN_USERNAME= :old.emp_id;
  ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0 AND NOT (INSTR(:new.DESIGNATION,'View') > 0) AND INSTR(:old.DESIGNATION ,'M') > 0  ) THEN 
     DELETE FROM  TTE_MANAGER_PROFILE  WHERE  MANAGER_ID= :old.emp_id;  
     DELETE FROM APEX_ACCESS_CONTROL  WHERE ADMIN_USERNAME = :old.emp_id;
  ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0  AND NOT (INSTR(:new.DESIGNATION,'View') > 0) AND INSTR(:old.DESIGNATION ,'IC') > 0 AND (INSTR(:old.DESIGNATION,'View') > 0 ) ) THEN 
     DELETE FROM APEX_ACCESS_CONTROL  WHERE ADMIN_USERNAME = :old.emp_id;
  ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0 AND (INSTR(:new.DESIGNATION,'View') > 0) AND INSTR(:old.DESIGNATION ,'M') > 0  ) THEN 
     DELETE FROM  TTE_MANAGER_PROFILE  WHERE  MANAGER_ID= :old.emp_id;  
     UPDATE APEX_ACCESS_CONTROL SET ADMIN_PRIVILEGES = 'EDIT' WHERE ADMIN_USERNAME= :old.emp_id;
  ELSIF (INSTR(:new.DESIGNATION ,'IC') > 0 AND (INSTR(:new.DESIGNATION,'View') > 0) AND INSTR(:old.DESIGNATION ,'IC') > 0 AND NOT (INSTR(:old.DESIGNATION,'View') > 0)  ) THEN 
     INSERT INTO APEX_ACCESS_CONTROL (ADMIN_USERNAME, ADMIN_PRIVILEGES, SETUP_ID)  VALUES (:new.emp_id, 'EDIT',1);	 
  END IF;
    
END;

/
ALTER TRIGGER  "TT_MGR_ACL_UPDATE" ENABLE
/